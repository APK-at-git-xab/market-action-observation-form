<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Qualitative Observation Input Forms</title>
    <!-- Your complete V3 stylesheet with modal styles -->
    <style>
        :root {
            --bg: #0f172a;
            --panel: #111827;
            --muted: #94a3b8;
            --text: #e5e7eb;
            --accent: #22d3ee;
            --accent-2: #a78bfa;
            --border: #1f2937;
            --ok: #34d399;
            --warn: #f59e0b;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans;
            background: linear-gradient(180deg, #0b1022, var(--bg));
            color: var(--text);
            line-height: 1.5;
        }

        .container {
            max-width: 1100px;
            margin: 32px auto;
            padding: 0 16px;
        }

        header {
            text-align: center;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        h1 {
            font-size: 36px;
            margin: 0;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            letter-spacing: -0.5px;
            flex: 1;
            text-align: left;
        }

        #auth-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 16px;
            width: 100%;
        }

        .tab {
            padding: 12px 20px;
            border: 1px solid var(--border);
            border-radius: 999px;
            cursor: pointer;
            background: #0b1222;
            color: var(--muted);
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 14px;
        }

        .tab:hover {
            background: rgba(34, 211, 238, 0.1);
            border-color: var(--accent);
            color: var(--accent);
            transform: translateY(-1px);
        }

        .tab[aria-selected="true"] {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
            color: #001018;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(34, 211, 238, 0.3);
        }

        .card {
            border: 1px solid var(--border);
            border-radius: 16px;
            margin-top: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .card header {
            border-bottom: 1px solid var(--border);
            padding: 20px 24px;
            background: rgba(255, 255, 255, 0.02);
        }

        .card h2 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
            color: var(--text);
        }

        .card main {
            padding: 24px;
        }

        fieldset {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            background: rgba(255, 255, 255, 0.01);
        }

        legend {
            padding: 0 12px;
            color: var(--accent-2);
            font-weight: 600;
            font-size: 16px;
            letter-spacing: 0.2px;
        }

        .instructions {
            font-size: 14px;
            color: var(--muted);
            margin-bottom: 16px;
            line-height: 1.6;
            font-style: italic;
        }

        label {
            display: block;
            font-size: 13px;
            color: var(--muted);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .question-label {
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 8px;
            display: inline-block;
            color: var(--text);
        }

        input[type="text"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: #0a0f1e;
            color: var(--text);
            font-family: inherit;
            font-size: 14px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.1);
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }

        select optgroup {
            font-style: italic;
            background: rgba(255, 255, 255, 0.05);
            color: var(--accent-2);
            font-weight: 600;
            padding: 8px;
        }

        select option {
            background: var(--panel);
            color: var(--text);
            padding: 10px 16px;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            line-height: 1.5;
        }

        .context-row {
            display: flex;
            gap: 40px;
            flex-wrap: wrap;
            align-items: end;
            margin-bottom: 8px;
        }

        .context-row > div {
            flex: 1;
            min-width: 150px;
        }

        .hidden {
            display: none !important;
        }

        .btnbar {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        button {
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        button.primary {
            background: var(--accent);
            color: #001018;
        }

        button.primary:hover {
            background: #1dd1db;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34, 211, 238, 0.3);
        }

        button.secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        button.secondary:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--accent);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }

        .checkbox-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--accent);
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
            accent-color: var(--accent);
            transform: scale(1.1);
        }

        .checkbox-item label {
            margin: 0;
            font-size: 13px;
            cursor: pointer;
            color: var(--text);
        }

        #signin-btn {
            background: var(--accent);
            color: #001018;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }

        #signout-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--muted);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        #user-email {
            color: var(--accent);
            font-weight: 500;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            color: var(--accent);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--muted);
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            background: #0a0f1e;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .preview-table th {
            background: var(--border);
            color: var(--accent);
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
        }

        .preview-table td {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            vertical-align: top;
        }

        .preview-table tr:last-child td {
            border-bottom: none;
        }

        .preview-table tr:hover {
            background: rgba(34, 211, 238, 0.05);
        }

        .field-label {
            color: var(--text);
            font-weight: 500;
            min-width: 150px;
        }

        .field-value {
            color: var(--muted);
            word-break: break-word;
        }

        .section-header {
            background: rgba(167, 139, 250, 0.1) !important;
            color: var(--accent-2) !important;
            font-weight: 700;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .json-preview {
            background: #0a0f1e;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text);
            white-space: pre-wrap;
            overflow-x: auto;
            display: none;
        }

        @media (max-width: 768px) {
            .context-row {
                flex-direction: column;
                gap: 16px;
            }

            .context-row > div {
                flex: none;
                width: 100%;
            }

            .checkbox-group {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: column;
                text-align: center;
            }

            h1 {
                text-align: center;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Qualitative Observation Input Forms</h1>
            <div id="auth-container">
                <button id="signin-btn">Sign In with Google</button>
                <div id="user-info" class="hidden">
                    <span id="user-email"></span>
                    <button id="signout-btn" class="secondary">Sign Out</button>
                </div>
            </div>
        </header>
        <div class="tabs" role="tablist" aria-label="Forms">
            <div class="tab" role="tab" id="tab-wyckoff" aria-controls="panel-wyckoff" aria-selected="true">Wyckoff Structure Vector</div>
            <div class="tab" role="tab" id="tab-auction" aria-controls="panel-auction" aria-selected="false">Auction Structure Vector</div>
        </div>

        <!-- YOUR FULL WYCKOFF FORM -->
        <section id="panel-wyckoff" role="tabpanel" aria-labelledby="tab-wyckoff" class="card">
            <header>
                <h2>Form 1 — Wyckoff Structure Vector Tracking</h2>
            </header>
            <main>
                <form id="form-wyckoff">
                    <fieldset>
                        <legend>Context (Where and When)</legend>
                        <div class="context-row">
                            <div>
                                <label for="wy_event_date">Event Date</label>
                                <input id="wy_event_date" name="event_date" type="date" required />
                            </div>
                            <div>
                                <label for="wy_instrument">Instrument</label>
                                <input id="wy_instrument" name="instrument" type="text" placeholder="ES" required />
                            </div>
                            <div>
                                <label for="wy_timeframe">Timeframe</label>
                                <select id="wy_timeframe" name="timeframe" required>
                                    <option value="">Select...</option>
                                    <option value="1D">1D</option>
                                    <option value="1Mil">1Mil</option>
                                    <option value="100k">100k</option>
                                </select>
                            </div>
                        </div>
                    </fieldset>
                    <fieldset>
                        <legend>The Event Section (The "What")</legend>
                        <p class="instructions">Log your specific Wyckoff interpretation.</p>
                        <label for="wy_event_code" class="question-label">Inferred Event / Setup</label>
                        <select id="wy_event_code" name="wyckoff_event_code" required>
                            <option value="">Select event...</option>
                            <optgroup label="General Tests & Setups">
                                <option value="WYCKOFF_ST_BOTTOM_LOW_VOL">ST of Bottom (LowVol)</option>
                                <option value="WYCKOFF_ST_BOTTOM_HIGH_VOL">ST of Bottom (HighVol)</option>
                                <option value="WYCKOFF_SPRING_SETUP">Spring / Shakeout Setup</option>
                                <option value="WYCKOFF_UPTHRUST_SETUP">Upthrust Setup</option>
                                <option value="WYCKOFF_SOS_ACTION">Sign of Strength (SOS) Action</option>
                                <option value="WYCKOFF_SOW_ACTION">Sign of Weakness (SOW) Action</option>
                                <option value="WYCKOFF_NEUTRAL_NO_EVENT">No Clear Event</option>
                            </optgroup>
                            <optgroup label="Confirmed Events">
                                <option value="WYCKOFF_SPRING_CONFIRMED">Spring Confirmed</option>
                                <option value="WYCKOFF_SPRING_FAILED">Spring Failed / SOW Confirmed</option>
                                <option value="WYCKOFF_UPTHRUST_CONFIRMED">Upthrust Confirmed</option>
                                <option value="WYCKOFF_UPTHRUST_FAILED">Upthrust Failed / SOS Confirmed</option>
                                <option value="WYCKOFF_LPS_CONFIRMED">Last Point of Support (LPS)</option>
                                <option value="WYCKOFF_LPSY_CONFIRMED">Last Point of Supply (LPSY)</option>
                            </optgroup>
                            <optgroup label="Phase A Events">
                                <option value="WYCKOFF_PHASE_A_PS">Preliminary Support (PS)</option>
                                <option value="WYCKOFF_PHASE_A_SC">Selling Climax (SC)</option>
                                <option value="WYCKOFF_PHASE_A_AR_ACCUM">Automatic Rally (AR) — Accumulation</option>
                                <option value="WYCKOFF_PHASE_A_PSY">Preliminary Supply (PSY)</option>
                                <option value="WYCKOFF_PHASE_A_BC">Buying Climax (BC)</option>
                                <option value="WYCKOFF_PHASE_A_AR_DIST">Automatic Reaction (AR) — Distribution</option>
                            </optgroup>
                        </select>
                    </fieldset>
                    <fieldset>
                        <legend>The Evidence Section (The "Why")</legend>
                        <p class="instructions">Supporting Evidence (Optional).</p>
                        <label class="question-label">Supporting Volume/Delta Evidence</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item"><input type="checkbox" id="vol_churn" name="volume_evidence" value="VOL_EVIDENCE_CHURN" /><label for="vol_churn">High Volume Churn</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="vol_exhaustion" name="volume_evidence" value="VOL_EVIDENCE_EXHAUSTION" /><label for="vol_exhaustion">Exhaustion Volume</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="vol_apathy" name="volume_evidence" value="VOL_EVIDENCE_APATHY" /><label for="vol_apathy">Low Volume / Apathy</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="vol_delta_bull" name="volume_evidence" value="VOL_EVIDENCE_DELTA_DIV_BULL" /><label for="vol_delta_bull">Positive Delta Divergence</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="vol_delta_bear" name="volume_evidence" value="VOL_EVIDENCE_DELTA_DIV_BEAR" /><label for="vol_delta_bear">Negative Delta Divergence</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="vol_large_lots" name="volume_evidence" value="VOL_EVIDENCE_LARGE_LOTS" /><label for="vol_large_lots">Large Lot Absorption</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="vol_trapped" name="volume_evidence" value="VOL_EVIDENCE_TRAPPED_TRADERS" /><label for="vol_trapped">Trapped Traders</label></div>
                        </div>
                    </fieldset>
                    <fieldset>
                        <legend>The Notes Section (The "Human Touch")</legend>
                        <label for="wy_analytical_notes" class="question-label">Analytical Notes</label>
                        <textarea id="wy_analytical_notes" name="analytical_notes" rows="4"></textarea>
                    </fieldset>
                    <div class="btnbar">
                        <button type="button" class="secondary" data-action="preview">Preview Data</button>
                        <button type="submit" class="primary">Submit</button>
                    </div>
                </form>
            </main>
        </section>

        <!-- YOUR FULL AUCTION FORM -->
        <section id="panel-auction" role="tabpanel" aria-labelledby="tab-auction" class="card hidden">
            <header>
                <h2>Form 2 — Auction Structure Vector Tracking</h2>
            </header>
            <main>
                <form id="form-auction">
                    <fieldset>
                        <legend>Context (Where and When)</legend>
                        <div class="context-row">
                            <div><label for="au_event_date">Event Date</label><input id="au_event_date" name="event_date" type="date" required /></div>
                            <div><label for="au_instrument">Instrument</label><input id="au_instrument" name="instrument" type="text" placeholder="ES" required /></div>
                            <div>
                              <label for="au_timeframe">Timeframe</label>
                              <select id="au_timeframe" name="timeframe" required>
                                  <option value="">Select...</option>
                                  <option value="1D">1D</option>
                                  <option value="1Mil">1Mil</option>
                                  <option value="100k">100k</option>
                              </select>
                            </div>
                        </div>
                    </fieldset>
                    <fieldset>
                        <legend>Dominant Trend Bias</legend>
                        <label for="au_volume_profile" class="question-label">Volume Profile Shape</label>
                        <p class="instructions">A classic way to interpret market sentiment and structure</p>
                        <select id="au_volume_profile" name="volume_profile_shape" required>
                            <option value="">Select...</option>
                            <option value="VP_SHAPE_D">D-Profile</option>
                            <option value="VP_SHAPE_P">p-Profile</option>
                            <option value="VP_SHAPE_B">b-Profile</option>
                            <option value="VP_SHAPE_DD">B-Profile</option>
                            <option value="VP_SHAPE_I">I-Profile</option>
                        </select>
                        <label for="au_swing_structure" class="question-label">Swing Structure</label>
                        <p class="instructions">Assesses the trend based on swing highs and lows</p>
                        <select id="au_swing_structure" name="swing_structure" required>
                            <option value="">Select...</option>
                            <option value="SWING_STRUCTURE_BULLISH_STRONG">Strong Bullish</option>
                            <option value="SWING_STRUCTURE_BULLISH_WEAK">Weak Bullish</option>
                            <option value="SWING_STRUCTURE_NEUTRAL_RANGEBOUND">Neutral</option>
                            <option value="SWING_STRUCTURE_BEARISH_WEAK">Weak Bearish</option>
                            <option value="SWING_STRUCTURE_BEARISH_STRONG">Strong Bearish</option>
                        </select>
                        <label for="au_bos" class="question-label">Break of Structure (BOS)</label>
                        <p class="instructions">Is the current bar causing a significant break of structure?</p>
                        <select id="au_bos" name="break_of_structure" required>
                            <option value="">Select...</option>
                            <option value="BOS_BULLISH_CONFIRMED">Confirmed Bullish</option>
                            <option value="BOS_BULLISH_UNCONFIRMED">Unconfirmed Bullish</option>
                            <option value="BOS_NEUTRAL_CONSOLIDATING">No BOS</option>
                            <option value="BOS_BEARISH_UNCONFIRMED">Unconfirmed Bearish</option>
                            <option value="BOS_BEARISH_CONFIRMED">Confirmed Bearish</option>
                        </select>
                        <label for="au_ichimoku" class="question-label">Ichimoku and Cloud</label>
                        <p class="instructions">Assesses the overall trend, momentum, and equilibrium</p>
                        <select id="au_ichimoku" name="ichimoku_cloud" required>
                            <option value="">Select...</option>
                            <option value="ICHIMOKU_BREAKOUT">Kumo Breakout</option>
                            <option value="ICHIMOKU_TREND_BULL">Full Bullish Alignment</option>
                            <option value="ICHIMOKU_PULLBACK_BULL">Bullish Trend with Weakness</option>
                            <option value="ICHIMOKU_NEUTRAL_IN_CLOUD">Neutral / In Cloud</option>
                            <option value="ICHIMOKU_BOUNCE_BEAR">Bearish Trend with Bounce</option>
                            <option value="ICHIMOKU_TREND_BEAR">Full Bearish Alignment</option>
                        </select>
                        <label for="au_daily_profile" class="question-label">Profile Geometry</label>
                        <p class="instructions">Structural Value Analysis. Assess how value is building.</p>
                        <select id="au_daily_profile" name="profile_geometry" required>
                            <option value="">Select...</option>
                            <option value="SVA_ACCEPTANCE_ABOVE_VAH">Acceptance Above Range</option>
                            <option value="SVA_REJECTION_AT_VAH">Rejection at Range High</option>
                            <option value="SVA_ROTATION_ABOVE_POC">Rotation Above POC</option>
                            <option value="SVA_REVERT_TO_POC_FROM_LOW">Mean Reversion to POC</option>
                            <option value="SVA_ROTATION_BELOW_POC">Rotation Below POC</option>
                            <option value="SVA_REJECTION_AT_VAL">Rejection at Range Low</option>
                            <option value="SVA_ACCEPTANCE_BELOW_VAL">Acceptance Below Range</option>
                        </select>
                        <label for="au_weis_wave" class="question-label">Weis Wave</label>
                        <p class="instructions">Inferred market behavior regarding effort vs. Result?</p>
                        <select id="au_weis_wave" name="weis_wave" required>
                            <option value="">Select...</option>
                            <option value="WW_SPRING_POTENTIAL">Bullish Reversal (Spring)</option>
                            <option value="WW_NO_SUPPLY">No Supply</option>
                            <option value="WW_INDECISION_CHURN">Indecision / Churn</option>
                            <option value="WW_NO_DEMAND">No Demand</option>
                            <option value="WW_UPTHRUST_POTENTIAL">Bearish Reversal (Upthrust)</option>
                        </select>
                    </fieldset>
                    <fieldset>
                        <legend>The Notes Section (The "Human Touch")</legend>
                        <label for="au_analytical_notes" class="question-label">Analytical Notes</label>
                        <textarea id="au_analytical_notes" name="analytical_notes" rows="3"></textarea>
                    </fieldset>
                    <div class="btnbar">
                        <button type="button" class="secondary" data-action="preview">Preview Data</button>
                        <button type="submit" class="primary">Submit</button>
                    </div>
                </form>
            </main>
        </section>

        <!-- YOUR FULL PREVIEW MODAL -->
        <div id="json-modal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">Data Preview</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="modal-table-content"></div>
                    <pre id="modal-json-content" class="json-preview"></pre>
                </div>
                <div class="modal-footer">
                    <button id="modal-toggle-btn" class="secondary">Show JSON</button>
                    <button id="modal-copy-btn">Copy Data</button>
                    <button id="modal-close-btn" class="secondary">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FINAL, WORKING SCRIPTS -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script>
        // --- 1. FIREBASE CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyA475g-a3QOgTIkf5fFUdfURHstSEtMtjY",
          authDomain: "kocm-mtf-analysis.firebaseapp.com",
          projectId: "kocm-mtf-analysis",
          storageBucket: "kocm-mtf-analysis.firebasestorage.app",
          messagingSenderId: "586253453045",
          appId: "1:586253453045:web:4c9eb00bfcbab15e0d27bc"
        };
        
        // --- explicitly define the oauth client id ---
         const OAUTH_CLIENT_ID = "586253453045-idqoj7siuvcqdv5htpbfirct94sivf36.apps.googleusercontent.com"
        
        // --- 2. CLOUD FUNCTION URLS ---
        const WYCKOFF_FORM_URL = 'https://us-central1-kocm-mtf-analysis.cloudfunctions.net/log-wyckoff-observation';
        const AUCTION_FORM_URL = 'https://us-central1-kocm-mtf-analysis.cloudfunctions.net/log-auction-observation';

        // --- 3. INITIALIZE & GET ELEMENTS ---
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();

        const signinBtn = document.getElementById('signin-btn');
        const signoutBtn = document.getElementById('signout-btn');
        const userInfo = document.getElementById('user-info');
        const userEmail = document.getElementById('user-email');
        const tabWy = document.getElementById('tab-wyckoff');
        const tabAu = document.getElementById('tab-auction');
        const panelWy = document.getElementById('panel-wyckoff');
        const panelAu = document.getElementById('panel-auction');
        const formWyckoff = document.getElementById('form-wyckoff');
        const formAuction = document.getElementById('form-auction');

        // --- 4. AUTH LOGIC ---
        signinBtn.addEventListener('click', () => auth.signInWithPopup(provider).catch(err => console.error("Sign in error:", err)));
        signoutBtn.addEventListener('click', () => auth.signOut());
        auth.onAuthStateChanged(user => {
            const allButtons = document.querySelectorAll('.btnbar button');
            if (user) {
                signinBtn.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userEmail.textContent = user.email;
                allButtons.forEach(btn => btn.disabled = false);
            } else {
                signinBtn.classList.remove('hidden');
                userInfo.classList.add('hidden');
                userEmail.textContent = '';
                allButtons.forEach(btn => btn.disabled = true);
            }
        });

        // --- 5. FORM HELPERS ---
        function formToJSON(form) {
            const data = new FormData(form);
            const json = {};
            json.submission_timestamp_client = new Date().toISOString();
            for (const [key, value] of data.entries()) {
                const checkboxes = form.querySelectorAll(`input[name="${key}"][type="checkbox"]`);
                if (checkboxes.length > 0) {
                    if (!json[key]) json[key] = [];
                    json[key].push(value);
                } else {
                    json[key] = value;
                }
            }
            return json;
        }
        document.querySelectorAll('input[type="date"]').forEach(el => el.value = new Date().toISOString().split('T')[0]);

        // --- 6. SUBMIT HANDLER ---
        async function handleFormSubmit(event, url) {
            event.preventDefault();
            const user = auth.currentUser;
            if (!user) {
                alert("You must be signed in.");
                return;
            }
            const form = event.target;
            const submitButton = form.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';
            const data = formToJSON(form);
            try {
                const idToken = await user.getIdToken(true);
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    submitButton.textContent = 'Success!';
                    form.reset();
                    document.querySelectorAll('input[type="date"]').forEach(el => el.value = new Date().toISOString().split('T')[0]);
                } else {
                    const error = await response.json();
                    submitButton.textContent = `Error: ${error.message || 'Check console'}`;
                }
            } catch (error) {
                submitButton.textContent = 'Network Error';
            }
            setTimeout(() => {
                submitButton.disabled = false;
                submitButton.textContent = originalButtonText;
            }, 3000);
        }

        // --- 7. ADVANCED PREVIEW MODAL LOGIC ---
        const modal = document.getElementById('json-modal');
        const modalTableContent = document.getElementById('modal-table-content');
        const modalJsonContent = document.getElementById('modal-json-content');
        const modalToggleBtn = document.getElementById('modal-toggle-btn');
        const modalCopyBtn = document.getElementById('modal-copy-btn');
        let currentJsonForModal = '';
        let isJsonView = false;

        const fieldLabelMap = { 'event_date': 'Event Date', 'instrument': 'Instrument', 'timeframe': 'Timeframe', 'wyckoff_event_code': 'Wyckoff Event', 'volume_evidence': 'Volume Evidence', 'analytical_notes': 'Analytical Notes', 'volume_profile_shape': 'Volume Profile', 'swing_structure': 'Swing Structure', 'break_of_structure': 'BOS', 'ichimoku_cloud': 'Ichimoku', 'profile_geometry': 'Profile Geometry', 'weis_wave': 'Weis Wave', 'submission_timestamp_client': 'Submitted At' };

        function createDataTable(formData) {
            const sections = {
                'CONTEXT': ['event_date', 'instrument', 'timeframe'],
                'ANALYSIS': Object.keys(formData).filter(k => !['event_date', 'instrument', 'timeframe', 'submission_timestamp_client', 'analytical_notes', 'volume_evidence', 'form_id'].includes(k)),
                'EVIDENCE': ['volume_evidence'],
                'NOTES': ['analytical_notes'],
                'SYSTEM': ['submission_timestamp_client']
            };
            let tableHTML = '<table class="preview-table"><thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>';
            for (const [section, fields] of Object.entries(sections)) {
                const relevantFields = fields.filter(f => formData[f] && formData[f].length > 0);
                if (relevantFields.length > 0) {
                    tableHTML += `<tr><td colspan="2" class="section-header">${section}</td></tr>`;
                    relevantFields.forEach(field => {
                        const label = fieldLabelMap[field] || field.replace(/_/g, ' ');
                        const value = Array.isArray(formData[field]) ? formData[field].join(', ') : formData[field];
                        tableHTML += `<tr><td>${label}</td><td>${value}</td></tr>`;
                    });
                }
            }
            tableHTML += '</tbody></table>';
            return tableHTML;
        }

        function showJsonModal(form) {
            const data = formToJSON(form);
            currentJsonForModal = JSON.stringify(data, null, 2);
            isJsonView = false;
            modalTableContent.innerHTML = createDataTable(data);
            modalJsonContent.textContent = currentJsonForModal;
            modalTableContent.style.display = 'block';
            modalJsonContent.style.display = 'none';
            modalToggleBtn.textContent = 'Show JSON';
            modal.classList.add('show');
        }

        function closeJsonModal() {
            modal.classList.remove('show');
        }

        modalToggleBtn.addEventListener('click', () => {
            isJsonView = !isJsonView;
            modalTableContent.style.display = isJsonView ? 'none' : 'block';
            modalJsonContent.style.display = isJsonView ? 'block' : 'none';
            modalToggleBtn.textContent = isJsonView ? 'Show Table' : 'Show JSON';
        });

        modalCopyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(currentJsonForModal);
            modalCopyBtn.textContent = 'Copied!';
            setTimeout(() => {
                modalCopyBtn.textContent = 'Copy Data';
            }, 2000);
        });

        modal.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', closeJsonModal));
        document.getElementById('modal-close-btn').addEventListener('click', closeJsonModal);


        // --- 8. UI EVENT LISTENERS ---
        tabWy.addEventListener('click', () => {
            panelWy.classList.remove('hidden');
            panelAu.classList.add('hidden');
            tabWy.setAttribute('aria-selected', true);
            tabAu.setAttribute('aria-selected', false);
        });
        tabAu.addEventListener('click', () => {
            panelWy.classList.add('hidden');
            panelAu.classList.remove('hidden');
            tabWy.setAttribute('aria-selected', false);
            tabAu.setAttribute('aria-selected', 'true');
        });

        formWyckoff.addEventListener('submit', (e) => handleFormSubmit(e, WYCKOFF_FORM_URL));
        formAuction.addEventListener('submit', (e) => handleFormSubmit(e, AUCTION_FORM_URL));

        formWyckoff.querySelector('[data-action="preview"]').addEventListener('click', () => showJsonModal(formWyckoff));
        formAuction.querySelector('[data-action="preview"]').addEventListener('click', () => showJsonModal(formAuction));

        // --- 9. INITIAL STATE ---
        document.querySelectorAll('.btnbar button').forEach(btn => btn.disabled = true);
    </script>
</body>
</html>









