<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Qualitative Observation Input Forms</title>
  <!-- Your complete V3 stylesheet -->
  <style>
    :root {
      --bg: #0f172a; --panel: #111827; --muted: #94a3b8; --text: #e5e7eb; --accent: #22d3ee; --accent-2: #a78bfa;
      --border: #1f2937; --form1-bg: rgba(17,24,39,0.85); --form2-bg: rgba(32,41,60,0.9); --phase-bg: rgba(255,255,255,0.05);
    }
    body { margin: 0; font-family: ui-sans-serif, system-ui, sans-serif; background: var(--bg); color: var(--text); }
    .container { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
    header { text-align: center; margin-bottom: 24px; position: relative; }
    h1 { font-size: 36px; margin: 0 0 16px 0; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 700; letter-spacing: -0.5px; }
    .tabs { display: flex; gap: 8px; justify-content: center; }
    .tab { padding: 12px 20px; border: 1px solid var(--border); border-radius: 999px; cursor: pointer; background: #0b1222; color: var(--muted); transition: all 0.3s ease; font-weight: 500; font-size: 14px; }
    .tab:hover { background: rgba(34, 211, 238, 0.1); border-color: var(--accent); color: var(--accent); transform: translateY(-1px); }
    .tab[aria-selected="true"] { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); color: #001018; font-weight: 600; box-shadow: 0 4px 12px rgba(34, 211, 238, 0.3); }
    .card { border: 1px solid var(--border); border-radius: 16px; margin-top: 16px; }
    .card header { border-bottom: 1px solid var(--border); padding: 16px 20px; }
    .card main { padding: 20px; }
    fieldset { border: 1px solid var(--border); border-radius: 12px; padding: 14px; margin-bottom: 16px; }
    legend { padding: 0 6px; color: var(--accent-2); font-weight: 600; }
    label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input[type="text"], input[type="date"], select, textarea { width: 100%; box-sizing: border-box; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: #0a0f1e; color: var(--text); font-family: inherit; }
    input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
    select optgroup { font-style: italic; background: var(--phase-bg); color: var(--muted); }
    .context-row { display: flex; gap: 20px; flex-wrap: wrap; align-items: end; }
    .context-row > div { flex: 1; min-width: 180px; }
    .hidden { display: none !important; }
    .btnbar { display: flex; justify-content: flex-end; gap: 8px; }
    button { padding: 8px 14px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; }
    button:disabled { cursor: not-allowed !important; background: #374151 !important; color: #9ca3af !important; opacity: 0.7; }
    button.primary { background: var(--accent); color: #001018; }
    button.secondary { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .instructions { font-size: 13px; color: var(--muted); margin-bottom: 8px; }
    .question-label { font-weight: bold; font-size: 14px; margin-bottom: 6px; display: inline-block; color: var(--text); }
    .checkbox-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; margin-top: 8px; }
    .checkbox-item { display: flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 8px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); transition: all 0.2s ease; }
    .checkbox-item:hover { background: rgba(255,255,255,0.05); border-color: var(--accent); }
    .checkbox-item input[type="checkbox"] { width: auto; margin: 0; accent-color: var(--accent); }
    .checkbox-item label { margin: 0; font-size: 13px; cursor: pointer; color: var(--text); }
    .grid { display: grid; gap: 16px; }
    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
    .grid-3 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    .chip { display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 8px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
    .chip:hover { border-color: var(--accent); }
    .chip input { width: auto; accent-color: var(--accent); }
    #auth-container { position: absolute; top: 0; right: 0; padding: 10px; z-index: 10; }
    #auth-container button { background: var(--border); color: var(--text); font-size: 12px; border: 1px solid var(--border); transition: all 0.2s ease; }
    #auth-container button:hover { background: var(--accent); color: #001018; }
    #user-info { display: flex; align-items: center; gap: 8px; font-size: 12px; }
    #user-email { color: var(--muted); }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div id="auth-container"><button id="signin-btn">Sign In with Google</button><div id="user-info" class="hidden"><span id="user-email"></span><button id="signout-btn">Sign Out</button></div></div>
      <h1>Qualitative Observation Input Forms</h1>
      <nav class="tabs" role="tablist" aria-label="Forms"><div class="tab" role="tab" id="tab-wyckoff" aria-controls="panel-wyckoff" aria-selected="true">Wyckoff Structure Vector</div><div class="tab" role="tab" id="tab-auction" aria-controls="panel-auction" aria-selected="false">Auction Structure Vector</div></nav>
    </header>

    <!-- YOUR FULL WYCKOFF FORM -->
    <section id="panel-wyckoff" role="tabpanel" aria-labelledby="tab-wyckoff" class="card" style="background: var(--form1-bg);">
      <header><h2>Form 1 — Wyckoff Structure Vector Tracking</h2></header>
      <main>
        <form>
          <fieldset><legend>Context (Where and When)</legend><div class="context-row"><div><label for="wy_event_date">Event Date</label><input id="wy_event_date" name="event_date" type="date" required /></div><div><label for="wy_instrument">Instrument</label><input id="wy_instrument" name="instrument" type="text" placeholder="ES" required /></div><div><label for="wy_timeframe">Timeframe</label><select id="wy_timeframe" name="timeframe" required><option value="">Select...</option><option value="1D">1D</option><option value="1Mil">1Mil</option><option value="100k">100k</option></select></div></div></fieldset>
          <fieldset><legend>The Event Section (The "What")</legend><p class="instructions">Log your specific Wyckoff interpretation.</p><label for="wy_event_code" class="question-label">Inferred Event / Setup</label><select id="wy_event_code" name="wyckoff_event_code" required><option value="">Select event...</option><optgroup label="General Tests & Setups"><option value="WYCKOFF_ST_BOTTOM_LOW_VOL">ST of Bottom (LowVol)</option><option value="WYCKOFF_ST_BOTTOM_HIGH_VOL">ST of Bottom (HighVol)</option></optgroup><optgroup label="Confirmed Events"><option value="WYCKOFF_SPRING_CONFIRMED">Spring Confirmed</option><option value="WYCKOFF_SPRING_FAILED">Spring Failed / SOW Confirmed</option></optgroup></select></fieldset>
          <fieldset><legend>The Evidence Section (The "Why")</legend><p class="instructions">Supporting Evidence (Optional).</p><label class="question-label">Supporting Volume/Delta Evidence</label><div class="checkbox-group"><div class="checkbox-item"><input type="checkbox" id="vol_churn" name="volume_evidence" value="VOL_EVIDENCE_CHURN" /><label for="vol_churn">High Volume Churn</label></div><div class="checkbox-item"><input type="checkbox" id="vol_exhaustion" name="volume_evidence" value="VOL_EVIDENCE_EXHAUSTION" /><label for="vol_exhaustion">Exhaustion Volume</label></div><div class="checkbox-item"><input type="checkbox" id="vol_apathy" name="volume_evidence" value="VOL_EVIDENCE_APATHY" /><label for="vol_apathy">Low Volume / Apathy</label></div></div></fieldset>
          <fieldset><legend>The Notes Section (The "Human Touch")</legend><label for="wy_analytical_notes" class="question-label">Analytical Notes</label><textarea id="wy_analytical_notes" name="analytical_notes" rows="4"></textarea></fieldset>
          <div class="btnbar"><button type="button" class="secondary" data-action="preview">Preview JSON</button><button type="submit" class="primary">Submit</button></div>
        </form>
      </main>
    </section>

    <!-- YOUR FULL AUCTION FORM -->
    <section id="panel-auction" role="tabpanel" aria-labelledby="tab-auction" class="card hidden" style="background: var(--form2-bg);">
      <header><h2>Form 2 — Auction Structure Vector Tracking</h2></header>
      <main>
        <form>
          <input type="hidden" name="form_id" value="auction_structure_vector" />
          <div class="grid grid-3 context-row">
            <div><label for="au_event_date">Event Date</label><input id="au_event_date" name="event_date" type="date" required /></div>
            <div><label for="au_instrument">Instrument</label><input id="au_instrument" name="instrument" type="text" placeholder="ES" required /></div>
            <div><label for="au_timeframe">Timeframe</label><input id="au_timeframe" name="timeframe" type="text" placeholder="1D" required /></div>
          </div>
          <div class="grid grid-2">
            <fieldset><legend>Volume Profile Shape</legend><div class="grid"><label class="chip"><input type="radio" name="vp_shape" value="VP_SHAPE_D" required /> D-Profile</label><label class="chip"><input type="radio" name="vp_shape" value="VP_SHAPE_P" /> p-Profile</label><label class="chip"><input type="radio" name="vp_shape" value="VP_SHAPE_B" /> b-Profile</label></div></fieldset>
            <fieldset><legend>Swing Structure</legend><div class="grid"><label class="chip"><input type="radio" name="swing_structure" value="SWING_STRUCTURE_BULLISH_STRONG" required /> Strong Bullish</label><label class="chip"><input type="radio" name="swing_structure" value="SWING_STRUCTURE_NEUTRAL_RANGEBOUND" /> Neutral</label><label class="chip"><input type="radio" name="swing_structure" value="SWING_STRUCTURE_BEARISH_STRONG" /> Strong Bearish</label></div></fieldset>
            <fieldset><legend>Break of Structure (BOS)</legend><div class="grid"><label class="chip"><input type="radio" name="bos" value="BOS_BULLISH_CONFIRMED" required /> Confirmed Bullish</label><label class="chip"><input type="radio" name="bos" value="BOS_NEUTRAL_CONSOLIDATING" /> No BOS</label><label class="chip"><input type="radio" name="bos" value="BOS_BEARISH_CONFIRMED" /> Confirmed Bearish</label></div></fieldset>
            <fieldset><legend>Ichimoku and Cloud</legend><div class="grid"><label class="chip"><input type="radio" name="ichimoku" value="ICHIMOKU_TREND_BULL" required /> Full Bullish</label><label class="chip"><input type="radio" name="ichimoku" value="ICHIMOKU_NEUTRAL_IN_CLOUD" /> Neutral</label><label class="chip"><input type="radio" name="ichimoku" value="ICHIMOKU_TREND_BEAR" /> Full Bearish</label></div></fieldset>
          </div>
          <fieldset><legend>Analytical Notes</legend><textarea id="au_analytical_notes" name="analytical_notes" rows="3"></textarea></fieldset>
          <div class="btnbar"><button type="button" class="secondary" data-action="preview">Preview JSON</button><button type="submit" class="primary">Submit</button></div>
        </form>
      </main>
    </section>
  </div>
  
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
  <script>
    // --- 1. FIREBASE CONFIGURATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyC-luLioK_DM2nIhD6KYG_LhOx9Y9Tdis0",
      authDomain: "market-observation-forms.firebaseapp.com",
      projectId: "market-observation-forms",
      storageBucket: "market-observation-forms.firebasestorage.app",
      messagingSenderId: "327733777418",
      appId: "1:327733777418:web:7755807347824bdd197bf3",
      measurementId: "G-45J44Q9KPV"
    };

    // --- 2. CLOUD FUNCTION URLS ---
    const WYCKOFF_FORM_URL = 'YOUR_WYCKOFF_CLOUD_FUNCTION_URL';
    const AUCTION_FORM_URL = 'YOUR_AUCTION_CLOUD_FUNCTION_URL';

    // --- 3. INITIALIZE FIREBASE & GET ELEMENTS ---
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();
    
    const signinBtn = document.getElementById('signin-btn');
    const signoutBtn = document.getElementById('signout-btn');
    const userInfo = document.getElementById('user-info');
    const userEmail = document.getElementById('user-email');
    const tabWy = document.getElementById('tab-wyckoff');
    const tabAu = document.getElementById('tab-auction');
    const panelWy = document.getElementById('panel-wyckoff');
    const panelAu = document.getElementById('panel-auction');
    const formWyckoff = panelWy.querySelector('form');
    const formAuction = panelAu.querySelector('form');

    // --- 4. AUTH LOGIC ---
    signinBtn.addEventListener('click', () => auth.signInWithPopup(provider).catch(err => console.error("Sign in error:", err)));
    signoutBtn.addEventListener('click', () => auth.signOut());
    auth.onAuthStateChanged(user => {
      const allButtons = document.querySelectorAll('.btnbar button');
      if (user) {
        signinBtn.classList.add('hidden');
        userInfo.classList.remove('hidden');
        userEmail.textContent = user.email;
        allButtons.forEach(btn => btn.disabled = false);
      } else {
        signinBtn.classList.remove('hidden');
        userInfo.classList.add('hidden');
        userEmail.textContent = '';
        allButtons.forEach(btn => btn.disabled = true);
      }
    });

    // --- 5. FORM HELPERS ---
    function formToJSON(form) {
      const data = new FormData(form);
      const json = {};
      json.submission_timestamp_client = new Date().toISOString();
      for (const [key, value] of data.entries()) {
        if (json[key]) {
          if (!Array.isArray(json[key])) { json[key] = [json[key]]; }
          json[key].push(value);
        } else { json[key] = value; }
      }
      if (json.volume_evidence && !Array.isArray(json.volume_evidence)) { json.volume_evidence = [json.volume_evidence]; }
      return json;
    }
    document.querySelectorAll('input[type="date"]').forEach(el => el.value = new Date().toISOString().split('T')[0]);

    // --- 6. SUBMIT HANDLER ---
    async function handleFormSubmit(event, url) {
      event.preventDefault();
      const user = auth.currentUser;
      if (!user) { alert("You must be signed in."); return; }
      const form = event.target;
      const submitButton = form.querySelector('button[type="submit"]');
      const originalButtonText = submitButton.textContent;
      submitButton.disabled = true;
      submitButton.textContent = 'Submitting...';
      try {
        const idToken = await user.getIdToken(true);
        const data = formToJSON(form);
        const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${idToken}` }, body: JSON.stringify(data) });
        if (response.ok) {
          submitButton.textContent = 'Success!';
          form.reset();
          document.querySelectorAll('input[type="date"]').forEach(el => el.value = new Date().toISOString().split('T')[0]);
        } else {
          const error = await response.json();
          submitButton.textContent = `Error: ${error.message || 'Check console'}`;
        }
      } catch (error) { submitButton.textContent = 'Network Error'; }
      setTimeout(() => {
        submitButton.disabled = false;
        submitButton.textContent = originalButtonText;
      }, 3000);
    }
    
    // --- 7. PREVIEW FUNCTION ---
    function showJsonPreview(form) {
        const data = formToJSON(form);
        // Using alert for simplicity, but you can restore your advanced modal here
        alert(JSON.stringify(data, null, 2));
    }

    // --- 8. UI EVENT LISTENERS ---
    tabWy.addEventListener('click', () => { panelWy.classList.remove('hidden'); panelAu.classList.add('hidden'); tabWy.setAttribute('aria-selected', true); tabAu.setAttribute('aria-selected', false); });
    tabAu.addEventListener('click', () => { panelWy.classList.add('hidden'); panelAu.classList.remove('hidden'); tabWy.setAttribute('aria-selected', false); tabAu.setAttribute('aria-selected', true); });

    formWyckoff.addEventListener('submit', (e) => handleFormSubmit(e, WYCKOFF_FORM_URL));
    formAuction.addEventListener('submit', (e) => handleFormSubmit(e, AUCTION_FORM_URL));
    
    formWyckoff.querySelector('[data-action="preview"]').addEventListener('click', () => showJsonPreview(formWyckoff));
    formAuction.querySelector('[data-action="preview"]').addEventListener('click', () => showJsonPreview(formAuction));

    // --- 9. INITIAL STATE ---
    document.querySelectorAll('.btnbar button').forEach(btn => btn.disabled = true);
  </script>
</body>
</html>
